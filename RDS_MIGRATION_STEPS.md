# é˜¿é‡Œäº‘ RDS è¿ç§»æ‰§è¡Œæ­¥éª¤ï¼ˆåœ¨æœ¬åœ° Mac æ‰§è¡Œï¼‰

## ğŸ–¥ï¸ æ‰§è¡Œä½ç½®

**æ‰€æœ‰å‘½ä»¤éƒ½åœ¨ä½ æœ¬åœ° Mac çš„ç»ˆç«¯æ‰§è¡Œï¼**

```
ä½ çš„ Mac ç»ˆç«¯
    â†“ é€šè¿‡ç½‘ç»œ
é˜¿é‡Œäº‘ RDSï¼ˆè¿œç¨‹æ•°æ®åº“ï¼‰
```

---

## å‡†å¤‡å·¥ä½œ

### 1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ MySQL å®¢æˆ·ç«¯

```bash
mysql --version
```

**å¦‚æœæ²¡æœ‰å®‰è£…ï¼š**
```bash
brew install mysql-client
echo 'export PATH="/opt/homebrew/opt/mysql-client/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

### 2. è·å–ä½ çš„å…¬ç½‘ IP

```bash
curl ifconfig.me
```

è®°ä¸‹è¿™ä¸ª IPï¼ˆä¾‹å¦‚ï¼š`123.45.67.89`ï¼‰

### 3. é…ç½® RDS ç™½åå•

1. ç™»å½• https://rdsnext.console.aliyun.com/
2. æ‰¾åˆ°ä½ çš„ RDS å®ä¾‹ï¼ˆrateyourdjï¼‰
3. ç‚¹å‡»å®ä¾‹åç§°è¿›å…¥è¯¦æƒ…
4. å·¦ä¾§èœå• "æ•°æ®å®‰å…¨æ€§" â†’ "ç™½åå•è®¾ç½®"
5. ç‚¹å‡» "ä¿®æ”¹" æˆ– "æ·»åŠ ç™½åå•åˆ†ç»„"
6. è¾“å…¥ä½ çš„ IP åœ°å€ï¼ˆä¸Šä¸€æ­¥è·å¾—çš„ï¼‰
7. ç‚¹å‡» "ç¡®å®š"

### 4. è·å– RDS è¿æ¥ä¿¡æ¯

åœ¨ RDS å®ä¾‹è¯¦æƒ…é¡µï¼Œä½ éœ€è¦è®°å½•ï¼š
- **å†…ç½‘åœ°å€** æˆ– **å¤–ç½‘åœ°å€**ï¼š`rm-xxxxx.mysql.rds.aliyuncs.com`
- **ç«¯å£**ï¼š`3306`
- **æ•°æ®åº“å**ï¼š`rateyourdj`
- **è´¦å·**ï¼š`root` æˆ–å…¶ä»–ç®¡ç†å‘˜è´¦å·
- **å¯†ç **ï¼šä½ çš„ RDS å¯†ç 

---

## æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰â­

### 1. ç¼–è¾‘è„šæœ¬ï¼Œå¡«å…¥ä½ çš„ RDS ä¿¡æ¯

```bash
cd /Users/yichengliang/Desktop/ws/rateyourdj
nano migrate-to-rds.sh
```

**ä¿®æ”¹è¿™ 4 è¡Œï¼ˆåœ¨æ–‡ä»¶å¼€å¤´ï¼‰ï¼š**
```bash
RDS_HOST="rm-xxx.mysql.rds.aliyuncs.com"  # æ”¹æˆä½ çš„ RDS åœ°å€
RDS_PORT="3306"                            # é€šå¸¸ä¸ç”¨æ”¹
RDS_USER="root"                            # æ”¹æˆä½ çš„ç”¨æˆ·å
RDS_DB="rateyourdj"                        # é€šå¸¸ä¸ç”¨æ”¹
```

æŒ‰ `Ctrl+X`ï¼Œç„¶å `Y`ï¼Œç„¶å `Enter` ä¿å­˜ã€‚

### 2. æ‰§è¡Œè„šæœ¬

```bash
./migrate-to-rds.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… æ‰§è¡Œè¿ç§»å‰æ£€æŸ¥ï¼ˆæ˜¾ç¤ºå½“å‰ 200 ä¸ª DJï¼‰
2. âœ… è¯¢é—®æ˜¯å¦å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
3. âœ… æ‰§è¡Œè¿ç§»è„šæœ¬
4. âœ… éªŒè¯è¿ç§»ç»“æœï¼ˆç¡®è®¤ DJ è¿˜æ˜¯ 200 ä¸ªï¼‰

æ¯ä¸€æ­¥éƒ½ä¼šè¯¢é—®ä½ æ˜¯å¦ç»§ç»­ï¼Œå¯ä»¥éšæ—¶ä¸­æ­¢ã€‚

---

## æ–¹æ³•äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œï¼ˆæ›´çµæ´»ï¼‰

### 1. æµ‹è¯•è¿æ¥

```bash
# æ›¿æ¢ä¸ºä½ çš„ RDS ä¿¡æ¯
mysql -h rm-xxx.mysql.rds.aliyuncs.com -P 3306 -u root -p rateyourdj

# è¾“å…¥å¯†ç ï¼Œå¦‚æœè¿æ¥æˆåŠŸä¼šçœ‹åˆ°ï¼š
mysql>

# æµ‹è¯•ä¸€ä¸‹ï¼š
mysql> SELECT COUNT(*) FROM djs;
# åº”è¯¥æ˜¾ç¤º 200

# é€€å‡ºï¼š
mysql> EXIT;
```

### 2. è¿ç§»å‰æ£€æŸ¥

```bash
cd /Users/yichengliang/Desktop/ws/rateyourdj

mysql -h rm-xxx.mysql.rds.aliyuncs.com \
      -P 3306 \
      -u root \
      -p \
      rateyourdj < rateyourdj-backend/migrations/pre-migration-check.sql
```

**é¢„æœŸè¾“å‡ºï¼š**
```
========== å½“å‰æ•°æ®åº“çŠ¶æ€ ==========
Tables Count: 8

========== å„è¡¨æ•°æ®é‡ ==========
djs: 200 rows
reviews: X rows
users: X rows
...

========== è¿ç§»çŠ¶æ€æ£€æŸ¥ ==========
âœ… å®‰å…¨ï¼šå¯ä»¥æ‰§è¡Œè¿ç§»
```

### 3. å¤‡ä»½æ•°æ®åº“

**é€‰é¡¹ Aï¼šé˜¿é‡Œäº‘æ§åˆ¶å°å¤‡ä»½ï¼ˆæ¨èï¼‰**
1. RDS æ§åˆ¶å° â†’ å¤‡ä»½æ¢å¤ â†’ å¤‡ä»½å®ä¾‹
2. é€‰æ‹© "ç‰©ç†å¤‡ä»½"
3. ç‚¹å‡» "ç¡®å®š"ï¼Œç­‰å¾…å®Œæˆï¼ˆ5-10 åˆ†é’Ÿï¼‰

**é€‰é¡¹ Bï¼šæœ¬åœ° mysqldump å¤‡ä»½**
```bash
mkdir -p ~/rateyourdj-backups

mysqldump -h rm-xxx.mysql.rds.aliyuncs.com \
          -P 3306 \
          -u root \
          -p \
          --single-transaction \
          --routines \
          --triggers \
          --databases rateyourdj \
          > ~/rateyourdj-backups/backup_$(date +%Y%m%d_%H%M%S).sql

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤§å°
ls -lh ~/rateyourdj-backups/
```

### 4. æ‰§è¡Œè¿ç§»

```bash
mysql -h rm-xxx.mysql.rds.aliyuncs.com \
      -P 3306 \
      -u root \
      -p \
      rateyourdj < rateyourdj-backend/migrations/001_add_waitlist_and_tasks.sql
```

è¾“å…¥å¯†ç åï¼Œç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆé€šå¸¸ 10-30 ç§’ï¼‰ã€‚

å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œè¯´æ˜æˆåŠŸï¼

### 5. éªŒè¯è¿ç§»ç»“æœ

```bash
mysql -h rm-xxx.mysql.rds.aliyuncs.com \
      -P 3306 \
      -u root \
      -p \
      rateyourdj < rateyourdj-backend/migrations/post-migration-check.sql
```

**å…³é”®æ£€æŸ¥ç‚¹ï¼š**
```
========== DJ æ•°æ®å®Œæ•´æ€§ ==========
Total DJs: 200  â† åº”è¯¥è¿˜æ˜¯ 200ï¼

========== Users è®¿é—®çº§åˆ«åˆ†å¸ƒ ==========
full: X  â† æ‰€æœ‰ç°æœ‰ç”¨æˆ·éƒ½æ˜¯ full

========== ä»»åŠ¡é…ç½®éªŒè¯ ==========
Total Tasks: 9  â† 9 ä¸ªä»»åŠ¡

âœ… å¦‚æœä»¥ä¸Šæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œè¿ç§»æˆåŠŸï¼
```

---

## å¸¸è§é—®é¢˜

### Q1: æ‰§è¡Œå‘½ä»¤æ—¶æç¤º "command not found: mysql"

**åŸå› **ï¼šæœ¬åœ°æ²¡å®‰è£… MySQL å®¢æˆ·ç«¯

**è§£å†³**ï¼š
```bash
brew install mysql-client
echo 'export PATH="/opt/homebrew/opt/mysql-client/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

### Q2: æç¤º "ERROR 2003: Can't connect to MySQL server"

**åŸå› **ï¼šRDS ç™½åå•æ²¡æœ‰é…ç½®æˆ– RDS åœ°å€é”™è¯¯

**è§£å†³**ï¼š
1. æ£€æŸ¥ RDS åœ°å€æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç™½åå•æ˜¯å¦æ·»åŠ äº†ä½ çš„ IP
3. å¦‚æœç”¨çš„æ˜¯å†…ç½‘åœ°å€ï¼Œç¡®ä¿ä½ çš„æœåŠ¡å™¨åœ¨åŒä¸€ VPC

### Q3: æç¤º "ERROR 1045: Access denied"

**åŸå› **ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯

**è§£å†³**ï¼š
1. ç¡®è®¤ç”¨æˆ·åæ˜¯å¦æ­£ç¡®ï¼ˆ`root` æˆ–å…¶ä»–ï¼‰
2. ç¡®è®¤å¯†ç æ˜¯å¦æ­£ç¡®
3. åœ¨ RDS æ§åˆ¶å°é‡ç½®å¯†ç 

### Q4: æƒ³ç”¨å¤–ç½‘åœ°å€ä½†æ²¡æœ‰

**è§£å†³**ï¼š
1. RDS æ§åˆ¶å° â†’ æ•°æ®åº“è¿æ¥
2. ç‚¹å‡» "ç”³è¯·å¤–ç½‘åœ°å€"
3. ç­‰å¾…åˆ†é…å®Œæˆï¼ˆå‡ åˆ†é’Ÿï¼‰
4. è®°å½•æ–°çš„å¤–ç½‘åœ°å€
5. æ³¨æ„ï¼šå¤–ç½‘åœ°å€ä¼šäº§ç”Ÿæµé‡è´¹ç”¨

### Q5: æ‰§è¡Œè„šæœ¬æç¤º "Permission denied"

**è§£å†³**ï¼š
```bash
chmod +x migrate-to-rds.sh
```

---

## å®‰å…¨æé†’

1. âœ… **å¿…é¡»å…ˆå¤‡ä»½**ï¼šæ— è®ºæ˜¯é˜¿é‡Œäº‘å¤‡ä»½è¿˜æ˜¯ mysqldump
2. âœ… **ç™½åå•è®¾ç½®**ï¼šè¿ç§»å®Œæˆåå¯ä»¥ç§»é™¤ä¸´æ—¶æ·»åŠ çš„ IP
3. âœ… **å¯†ç å®‰å…¨**ï¼šä¸è¦æŠŠå¯†ç å†™åœ¨è„šæœ¬é‡Œï¼Œæ¯æ¬¡æ‰‹åŠ¨è¾“å…¥
4. âœ… **éªŒè¯ç»“æœ**ï¼šè¿ç§»åä¸€å®šè¦è¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥æ•°æ®å®Œæ•´æ€§

---

## è¿ç§»åç»­æ­¥éª¤

æ•°æ®åº“è¿ç§»å®Œæˆåï¼š

1. **éƒ¨ç½²åç«¯ä»£ç **ï¼ˆSSH åˆ°ç”Ÿäº§æœåŠ¡å™¨ï¼‰ï¼š
   ```bash
   cd /path/to/rateyourdj-backend
   git pull origin feature/waitlist-task-system
   npm install
   pm2 restart rateyourdj
   ```

2. **ä¸Šä¼ å°ç¨‹åºæ–°ç‰ˆæœ¬**ï¼š
   - å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ ä¸Šä¼ 
   - å¾®ä¿¡å…¬ä¼—å¹³å° â†’ æäº¤å®¡æ ¸

3. **æµ‹è¯•åŠŸèƒ½**ï¼š
   - æµ‹è¯•æ–°ç”¨æˆ·ç™»å½•ï¼ˆè¿›å…¥ waitlistï¼‰
   - æµ‹è¯•é‚€è¯·ç ä½¿ç”¨
   - æµ‹è¯•ä»»åŠ¡ç³»ç»Ÿ
   - æµ‹è¯•ç°æœ‰ç”¨æˆ·æ­£å¸¸è®¿é—®

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹æ‰§è¡Œå§ï¼** ğŸš€

å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥éšæ—¶å›æ»šåˆ°å¤‡ä»½ã€‚
