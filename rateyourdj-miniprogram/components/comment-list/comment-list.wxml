<view class="comment-list">
  <view wx:for="{{processedComments}}" wx:key="id" class="comment-item" style="padding-left: {{item.depth * 40}}rpx">
    <!-- 评论头部 -->
    <view class="comment-header">
      <image class="avatar" src="{{item.avatar_url || '/images/default-avatar.png'}}" lazy-load />
      <view class="user-info">
        <text class="nickname">{{item.nickname}}</text>
        <text class="time">{{item.timeAgo}}</text>
      </view>
    </view>

    <!-- 评论内容 -->
    <view class="comment-content">{{item.content}}</view>

    <!-- 投票和操作 -->
    <view class="comment-actions">
      <view class="vote-section">
        <view class="vote-btn upvote {{item.user_vote_type === 'upvote' ? 'voted' : ''}}" bindtap="onUpvote" data-id="{{item.id}}">
          {{item.user_vote_type === 'upvote' ? '▲' : '△'}}
        </view>
        <text class="vote-score">{{item.vote_score}}</text>
        <view class="vote-btn downvote {{item.user_vote_type === 'downvote' ? 'voted' : ''}}" bindtap="onDownvote" data-id="{{item.id}}">
          {{item.user_vote_type === 'downvote' ? '▼' : '▽'}}
        </view>
      </view>

      <view class="reply-btn" bindtap="toggleReplyBox" data-id="{{item.id}}" data-nickname="{{item.nickname}}" wx:if="{{item.depth < 2}}">
        回复
      </view>

      <view class="delete-btn" bindtap="onDelete" data-id="{{item.id}}" wx:if="{{item.canDelete}}">
        删除
      </view>
    </view>

    <!-- 回复输入框（点击回复后展开） -->
    <view wx:if="{{replyingCommentId === item.id}}" class="reply-input-box">
      <input class="reply-input"
             placeholder="回复 @{{replyingNickname}}..."
             bindinput="onReplyInput"
             bindconfirm="submitReply"
             value="{{replyInputValue}}"
             maxlength="500"
             focus="{{true}}" />
      <view class="reply-actions">
        <button class="cancel-reply-btn" bindtap="cancelReply">取消</button>
        <button class="submit-reply-btn" bindtap="submitReply">发送</button>
      </view>
    </view>

    <!-- 嵌套回复（递归，带折叠功能） -->
    <view wx:if="{{item.visibleReplies && item.visibleReplies.length > 0}}" class="nested-replies">
      <comment-list
        comments="{{item.visibleReplies}}"
        reviewId="{{reviewId}}"
        replyingCommentId="{{replyingCommentId}}"
        replyingNickname="{{replyingNickname}}"
        replyInputValue="{{replyInputValue}}"
        bind:upvote="onUpvote"
        bind:downvote="onDownvote"
        bind:reply="onReply"
        bind:toggleReply="onToggleReply"
        bind:replyInput="onReplyInput"
        bind:submitReply="onSubmitReply"
        bind:cancelReply="onCancelReply"
        bind:delete="onDelete"
        bind:expandReplies="onExpandReplies" />

      <!-- 如果回复超过 3 条且未展开，显示"查看更多"按钮 -->
      <view wx:if="{{item.hasMoreReplies && !expandedReplies[item.id]}}" class="view-more-replies" bindtap="toggleExpandReplies" data-comment-id="{{item.id}}">
        <text class="view-more-text">查看更多 {{item.hiddenCount}} 条回复</text>
        <text class="arrow">▼</text>
      </view>

      <!-- 如果已展开且回复超过 3 条，显示"收起"按钮 -->
      <view wx:if="{{item.hasMoreReplies && expandedReplies[item.id]}}" class="view-more-replies" bindtap="toggleExpandReplies" data-comment-id="{{item.id}}">
        <text class="view-more-text">收起回复</text>
        <text class="arrow">▲</text>
      </view>
    </view>
  </view>
</view>
