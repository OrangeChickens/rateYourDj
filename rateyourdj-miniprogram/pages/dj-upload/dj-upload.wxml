<!--pages/dj-upload/dj-upload.wxml-->

<!-- WXS æ¨¡å—ï¼šç”¨äºæ£€æŸ¥æ ‡ç­¾æ˜¯å¦è¢«é€‰ä¸­ -->
<wxs module="tools">
  var isSelected = function(selectedStyles, tagName) {
    for (var i = 0; i < selectedStyles.length; i++) {
      if (selectedStyles[i] === tagName) {
        return true;
      }
    }
    return false;
  };

  module.exports = {
    isSelected: isSelected
  };
</wxs>

<view class="container {{animationPhase === 'slide-up' ? 'sliding-up' : ''}}">
  <view class="form-section">
    <view class="form-title">{{isAdmin ? 'ä¸Šä¼ DJèµ„æ–™' : 'æäº¤DJèµ„æ–™'}}</view>

    <!-- DJç…§ç‰‡ -->
    <view class="form-item">
      <text class="label">DJç…§ç‰‡ *</text>
      <view class="image-upload" bindtap="chooseImage">
        <image wx:if="{{localImagePath}}" src="{{localImagePath}}" mode="aspectFill" class="preview-image" />
        <view wx:else class="upload-placeholder">
          <text class="upload-icon">+</text>
          <text class="upload-text">SELECT PHOTO</text>
        </view>
      </view>
    </view>

    <!-- DJåç§° -->
    <view class="form-item">
      <text class="label">DJåç§° *</text>
      <input
        class="input"
        placeholder="è¯·è¾“å…¥DJåç§°"
        value="{{name}}"
        bindinput="onNameInput"
      />
    </view>

    <!-- åŸå¸‚é€‰æ‹© - ä½¿ç”¨å¾®ä¿¡ region ç»„ä»¶ -->
    <view class="form-item">
      <text class="label">åŸå¸‚ *</text>
      <picker
        mode="region"
        bindchange="onCityChange"
        value="{{cityRegion}}"
        custom-item="{{customCityItem}}"
      >
        <view class="picker">
          {{city || 'è¯·é€‰æ‹©åŸå¸‚'}}
        </view>
      </picker>
    </view>

    <!-- å‚ç‰Œé€‰æ‹© - å¯é€‰æ‹©ç°æœ‰æˆ–è‡ªå®šä¹‰ -->
    <view class="form-item">
      <text class="label">å‚ç‰Œ</text>
      <picker
        bindchange="onLabelChange"
        value="{{labelIndex}}"
        range="{{labelOptions}}"
      >
        <view class="picker">
          {{label || 'è¯·é€‰æ‹©å‚ç‰Œï¼ˆé€‰å¡«ï¼‰'}}
        </view>
      </picker>
    </view>

    <!-- è‡ªå®šä¹‰å‚ç‰Œè¾“å…¥æ¡†ï¼ˆå½“é€‰æ‹©"è‡ªå®šä¹‰"æ—¶æ˜¾ç¤ºï¼‰ -->
    <view class="form-item" wx:if="{{showCustomLabel}}">
      <text class="label">è‡ªå®šä¹‰å‚ç‰Œ</text>
      <input
        class="input"
        placeholder="è¯·è¾“å…¥å‚ç‰Œåç§°"
        value="{{customLabel}}"
        bindinput="onCustomLabelInput"
      />
    </view>

    <!-- éŸ³ä¹é£æ ¼é€‰æ‹© - åˆ†ç±»æŠ˜å  + æœç´¢ -->
    <view class="form-item">
      <text class="label">éŸ³ä¹é£æ ¼ (å·²é€‰{{selectedStyles.length}}/5)</text>

      <!-- æœç´¢æ¡† -->
      <view class="search-box">
        <input
          class="search-input"
          placeholder="ğŸ” æœç´¢é£æ ¼..."
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
        />
      </view>

      <!-- Genre â†’ Subgroup ä¸¤çº§åˆ†ç±» -->
      <view class="style-categories">
        <view
          wx:for="{{styleCategories}}"
          wx:key="name"
          class="genre-group"
        >
          <!-- Genre Group header (level 1) -->
          <view
            class="category-header"
            bindtap="toggleGenreGroup"
            data-name="{{item.name}}"
          >
            <text class="category-icon">{{expandedGroups[item.name] ? 'â–¼' : 'â–¶'}}</text>
            <text class="category-title">{{item.name}} ({{item.totalCount}})</text>
          </view>

          <!-- Subgroups (level 2) -->
          <view
            wx:if="{{expandedGroups[item.name]}}"
            class="subgroups-container"
          >
            <view
              wx:for="{{item.subgroups}}"
              wx:for-item="subgroup"
              wx:key="name"
              class="subgroup"
            >
              <text class="subgroup-title">{{subgroup.name}}</text>
              <view class="subgroup-tags">
                <block wx:for="{{subgroup.tags}}" wx:for-item="tag" wx:key="id">
                  <view
                    class="tag-item {{tools.isSelected(selectedStyles, tag.name) ? 'selected' : ''}}"
                    bindtap="onStyleTagTap"
                    data-name="{{tag.name}}"
                  >
                    {{tag.name}}
                  </view>
                </block>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="hint-text">æœ€å¤šé€‰æ‹© 5 ä¸ªæ ‡ç­¾</view>
    </view>

    <!-- åº•éƒ¨é—´è· -->
    <view style="height: 280rpx;"></view>
  </view>

  <!-- æ­¥éª¤1ï¼šç¡®è®¤æäº¤ -->
  <view
    wx:if="{{!readyToSwipe}}"
    class="swipe-submit-area"
    bindtap="confirmReady"
  >
    <view class="swipe-indicator">
      <text class="swipe-icon">â†‘</text>
      <text class="swipe-text">ç¡®å®šæäº¤?</text>
    </view>
  </view>

  <!-- æ­¥éª¤2ï¼šä¸Šæ»‘æäº¤ -->
  <view
    wx:if="{{readyToSwipe}}"
    class="swipe-submit-area {{swipeProgress > 0 ? 'active' : ''}}"
    bindtouchstart="handleTouchStart"
    bindtouchmove="handleTouchMove"
    bindtouchend="handleTouchEnd"
  >
    <view class="swipe-indicator" style="transform: translateY({{-swipeProgress * 0.3}}rpx)">
      <text class="swipe-icon">â†‘</text>
      <text class="swipe-text">{{swipeProgress >= 100 ? 'æ¾æ‰‹æäº¤' : 'å‘ä¸Šæ»‘åŠ¨æäº¤'}}</text>
    </view>
    <view class="swipe-progress-bar">
      <view class="swipe-progress-fill" style="width: {{swipeProgress}}%"></view>
    </view>
  </view>
</view>

<!-- æäº¤åŠ¨ç”»é®ç½©å±‚ -->
<view class="submit-animation-overlay {{showSubmitAnimation ? 'show' : ''}}">
  <view class="animation-content {{animationPhase}}">
    <view class="confetti-container" wx:if="{{animationPhase === 'success'}}">
      <view wx:for="{{confettiPieces}}" wx:key="index"
            class="confetti"
            style="left: {{item.left}}%; animation-delay: {{item.delay}}s; background-color: {{item.color}}; animation-duration: {{item.duration}}s;">
      </view>
    </view>
    <view class="success-content" wx:if="{{animationPhase === 'success'}}">
      <view class="success-icon">âœ“</view>
      <text class="success-text">{{isAdmin ? 'DJå·²åˆ›å»º' : 'å·²æäº¤å®¡æ ¸'}}</text>
    </view>
  </view>
</view>
