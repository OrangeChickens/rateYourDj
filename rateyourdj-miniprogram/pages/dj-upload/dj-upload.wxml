<!--pages/dj-upload/dj-upload.wxml-->

<!-- WXS æ¨¡å—ï¼šç”¨äºæ£€æŸ¥æ ‡ç­¾æ˜¯å¦è¢«é€‰ä¸­ -->
<wxs module="tools">
  var isSelected = function(selectedStyles, tagName) {
    for (var i = 0; i < selectedStyles.length; i++) {
      if (selectedStyles[i] === tagName) {
        return true;
      }
    }
    return false;
  };

  module.exports = {
    isSelected: isSelected
  };
</wxs>

<view class="container">
  <view class="form-section">
    <view class="form-title">{{isAdmin ? 'ä¸Šä¼ DJèµ„æ–™' : 'æäº¤DJèµ„æ–™'}}</view>

    <!-- DJç…§ç‰‡ -->
    <view class="form-item">
      <text class="label">DJç…§ç‰‡ *</text>
      <view class="image-upload" bindtap="chooseImage">
        <image wx:if="{{localImagePath}}" src="{{localImagePath}}" mode="aspectFill" class="preview-image" />
        <view wx:else class="upload-placeholder">
          <text class="upload-icon">ğŸ“·</text>
          <text class="upload-text">ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</text>
        </view>
      </view>
    </view>

    <!-- DJåç§° -->
    <view class="form-item">
      <text class="label">DJåç§° *</text>
      <input
        class="input"
        placeholder="è¯·è¾“å…¥DJåç§°"
        value="{{name}}"
        bindinput="onNameInput"
      />
    </view>

    <!-- åŸå¸‚é€‰æ‹© - ä½¿ç”¨å¾®ä¿¡ region ç»„ä»¶ -->
    <view class="form-item">
      <text class="label">åŸå¸‚ *</text>
      <picker
        mode="region"
        bindchange="onCityChange"
        value="{{cityRegion}}"
        custom-item="{{customCityItem}}"
      >
        <view class="picker">
          {{city || 'è¯·é€‰æ‹©åŸå¸‚'}}
        </view>
      </picker>
    </view>

    <!-- å‚ç‰Œé€‰æ‹© - å¯é€‰æ‹©ç°æœ‰æˆ–è‡ªå®šä¹‰ -->
    <view class="form-item">
      <text class="label">å‚ç‰Œ</text>
      <picker
        bindchange="onLabelChange"
        value="{{labelIndex}}"
        range="{{labelOptions}}"
      >
        <view class="picker">
          {{label || 'è¯·é€‰æ‹©å‚ç‰Œï¼ˆé€‰å¡«ï¼‰'}}
        </view>
      </picker>
    </view>

    <!-- è‡ªå®šä¹‰å‚ç‰Œè¾“å…¥æ¡†ï¼ˆå½“é€‰æ‹©"è‡ªå®šä¹‰"æ—¶æ˜¾ç¤ºï¼‰ -->
    <view class="form-item" wx:if="{{showCustomLabel}}">
      <text class="label">è‡ªå®šä¹‰å‚ç‰Œ</text>
      <input
        class="input"
        placeholder="è¯·è¾“å…¥å‚ç‰Œåç§°"
        value="{{customLabel}}"
        bindinput="onCustomLabelInput"
      />
    </view>

    <!-- éŸ³ä¹é£æ ¼é€‰æ‹© - åˆ†ç±»æŠ˜å  + æœç´¢ -->
    <view class="form-item">
      <text class="label">éŸ³ä¹é£æ ¼ (å·²é€‰{{selectedStyles.length}}/5)</text>

      <!-- æœç´¢æ¡† -->
      <view class="search-box">
        <input
          class="search-input"
          placeholder="ğŸ” æœç´¢é£æ ¼..."
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
        />
      </view>

      <!-- Genre â†’ Subgroup ä¸¤çº§åˆ†ç±» -->
      <view class="style-categories">
        <view
          wx:for="{{styleCategories}}"
          wx:key="name"
          class="genre-group"
        >
          <!-- Genre Group header (level 1) -->
          <view
            class="category-header"
            bindtap="toggleGenreGroup"
            data-name="{{item.name}}"
          >
            <text class="category-icon">{{expandedGroups[item.name] ? 'â–¼' : 'â–¶'}}</text>
            <text class="category-title">{{item.name}} ({{item.totalCount}})</text>
          </view>

          <!-- Subgroups (level 2) -->
          <view
            wx:if="{{expandedGroups[item.name]}}"
            class="subgroups-container"
          >
            <view
              wx:for="{{item.subgroups}}"
              wx:for-item="subgroup"
              wx:key="name"
              class="subgroup"
            >
              <text class="subgroup-title">{{subgroup.name}}</text>
              <view class="subgroup-tags">
                <block wx:for="{{subgroup.tags}}" wx:for-item="tag" wx:key="id">
                  <view
                    class="tag-item {{tools.isSelected(selectedStyles, tag.name) ? 'selected' : ''}}"
                    bindtap="onStyleTagTap"
                    data-name="{{tag.name}}"
                  >
                    {{tag.name}}
                  </view>
                </block>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="hint-text">æœ€å¤šé€‰æ‹© 5 ä¸ªæ ‡ç­¾</view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button
      class="submit-btn"
      bindtap="handleSubmit"
      disabled="{{uploading}}"
    >
      {{uploading ? 'ä¸Šä¼ ä¸­...' : (isAdmin ? 'æäº¤' : 'æäº¤å®¡æ ¸')}}
    </button>
  </view>
</view>
