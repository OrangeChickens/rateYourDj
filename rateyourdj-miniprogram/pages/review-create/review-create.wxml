<!--pages/review-create/review-create.wxml-->

<!-- WXS æ¨¡å—ï¼šç”¨äºæ£€æŸ¥æ ‡ç­¾æ˜¯å¦è¢«é€‰ä¸­ -->
<wxs module="tools">
  var isSelected = function(selectedTags, tagName) {
    for (var i = 0; i < selectedTags.length; i++) {
      if (selectedTags[i] === tagName) {
        return true;
      }
    }
    return false;
  };

  module.exports = {
    isSelected: isSelected
  };
</wxs>

<view class="container {{animationPhase === 'slide-up' ? 'sliding-up' : ''}}">
  <view class="page-header">
    <text class="dj-name">{{djName}}</text>
  </view>

  <scroll-view scroll-y class="form-content">
    <!-- ç»¼åˆè¯„åˆ† -->
    <view class="rating-section">
      <view class="section-title">{{texts.rateOverall}} *</view>
      <view class="stars-input">
        <text
          wx:for="{{[1,2,3,4,5]}}"
          wx:key="index"
          class="star {{overallRating >= item ? 'active' : ''}}"
          bindtap="setRating"
          data-type="overallRating"
          data-value="{{item}}"
        >â˜…</text>
      </view>
      <text class="rating-value">{{overallRating || '-'}}/5</text>
    </view>

    <!-- Setè¯„åˆ† -->
    <view class="rating-section">
      <view class="section-title">{{texts.rateSet}} *</view>
      <view class="stars-input">
        <text
          wx:for="{{[1,2,3,4,5]}}"
          wx:key="index"
          class="star {{setRating >= item ? 'active' : ''}}"
          bindtap="setRating"
          data-type="setRating"
          data-value="{{item}}"
        >â˜…</text>
      </view>
      <text class="rating-value">{{setRating || '-'}}/5</text>
    </view>

    <!-- è¡¨æ¼”åŠ›è¯„åˆ† -->
    <view class="rating-section">
      <view class="section-title">{{texts.ratePerformance}} *</view>
      <view class="stars-input">
        <text
          wx:for="{{[1,2,3,4,5]}}"
          wx:key="index"
          class="star {{performanceRating >= item ? 'active' : ''}}"
          bindtap="setRating"
          data-type="performanceRating"
          data-value="{{item}}"
        >â˜…</text>
      </view>
      <text class="rating-value">{{performanceRating || '-'}}/5</text>
    </view>

    <!-- æ€§æ ¼è¯„åˆ† -->
    <view class="rating-section">
      <view class="section-title">{{texts.ratePersonality}} *</view>
      <view class="stars-input">
        <text
          wx:for="{{[1,2,3,4,5]}}"
          wx:key="index"
          class="star {{personalityRating >= item ? 'active' : ''}}"
          bindtap="setRating"
          data-type="personalityRating"
          data-value="{{item}}"
        >â˜…</text>
      </view>
      <text class="rating-value">{{personalityRating || '-'}}/5</text>
    </view>

    <!-- æ˜¯å¦ä¼šå†é€‰ -->
    <view class="toggle-section">
      <text class="section-title">{{texts.wouldChooseAgain}}</text>
      <switch
        checked="{{wouldChooseAgain}}"
        bindchange="toggleWouldChoose"
        color="#FFD700"
      />
    </view>

    <!-- æ ‡ç­¾é€‰æ‹© -->
    <view class="tags-section">
      <view class="section-title">{{texts.selectTags}} ({{selectedTags.length}}/{{maxTags}})</view>

      <!-- éŸ³ä¹é£æ ¼æ ‡ç­¾ - åˆ†ç±»æŠ˜å  + æœç´¢ -->
      <view class="tag-group">
        <text class="group-title">{{texts.styleTags}}</text>

        <!-- æœç´¢æ¡† -->
        <view class="search-box">
          <input
            class="search-input"
            placeholder="ğŸ” æœç´¢é£æ ¼..."
            value="{{searchKeyword}}"
            bindinput="onSearchInput"
          />
        </view>

        <!-- Genre â†’ Subgroup ä¸¤çº§åˆ†ç±» -->
        <view class="style-categories">
          <view
            wx:for="{{styleCategories}}"
            wx:key="name"
            class="genre-group"
          >
            <!-- Genre Group header (level 1) -->
            <view
              class="category-header"
              bindtap="toggleGenreGroup"
              data-name="{{item.name}}"
            >
              <text class="category-icon">{{expandedGroups[item.name] ? 'â–¼' : 'â–¶'}}</text>
              <text class="category-title">{{item.name}} ({{item.totalCount}})</text>
            </view>

            <!-- Subgroups (level 2) -->
            <view
              wx:if="{{expandedGroups[item.name]}}"
              class="subgroups-container"
            >
              <view
                wx:for="{{item.subgroups}}"
                wx:for-item="subgroup"
                wx:key="name"
                class="subgroup"
              >
                <text class="subgroup-title">{{subgroup.name}}</text>
                <view class="subgroup-tags">
                  <block wx:for="{{subgroup.tags}}" wx:for-item="tag" wx:key="id">
                    <view
                      class="tag-item {{tools.isSelected(selectedTags, tag.name) ? 'selected' : ''}}"
                      bindtap="toggleStyleTag"
                      data-name="{{tag.name}}"
                    >
                      {{tag.name}}
                    </view>
                  </block>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥ -->
        <view class="custom-tag-row">
          <input
            class="search-input"
            placeholder="è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾..."
            value="{{customTagInput}}"
            bindinput="onCustomTagInput"
            bindconfirm="addCustomTag"
            maxlength="20"
          />
          <view class="custom-tag-btn" bindtap="addCustomTag">+</view>
        </view>
        <view class="tag-list" wx:if="{{customTags.length > 0}}">
          <view
            wx:for="{{customTags}}"
            wx:key="*this"
            class="tag selected"
            bindtap="removeCustomTag"
            data-name="{{item}}"
          >{{item}} Ã—</view>
        </view>
      </view>

      <!-- è¡¨ç°åŠ›æ ‡ç­¾ -->
      <view class="tag-group">
        <text class="group-title">{{texts.performanceTags}}</text>
        <view class="tag-list">
          <view
            wx:for="{{presetTags}}"
            wx:if="{{item.category === 'performance'}}"
            wx:key="id"
            class="tag {{item.selected ? 'selected' : ''}}"
            bindtap="toggleTag"
            data-name="{{item.name}}"
            data-index="{{index}}"
          >{{item.name}}</view>
        </view>
      </view>

      <!-- æ€§æ ¼æ ‡ç­¾ -->
      <view class="tag-group">
        <text class="group-title">{{texts.personalityTags}}</text>
        <view class="tag-list">
          <view
            wx:for="{{presetTags}}"
            wx:if="{{item.category === 'personality'}}"
            wx:key="id"
            class="tag {{item.selected ? 'selected' : ''}}"
            bindtap="toggleTag"
            data-name="{{item.name}}"
            data-index="{{index}}"
          >{{item.name}}</view>
        </view>
      </view>
    </view>

    <!-- æ–‡å­—è¯„è®º -->
    <view class="comment-section">
      <view class="section-title">{{texts.writeComment}} *</view>
      <textarea
        class="comment-input"
        placeholder="{{texts.commentPlaceholder}}"
        value="{{comment}}"
        bindinput="onCommentInput"
        maxlength="500"
        auto-height
      />
      <view class="char-count">{{comment.length}}/500</view>
    </view>

    <!-- åŒ¿åé€‰é¡¹ -->
    <view class="anonymous-section">
      <text class="section-title">{{texts.anonymous}}</text>
      <switch
        checked="{{isAnonymous}}"
        bindchange="toggleAnonymous"
        color="#FFD700"
      />
    </view>

    <!-- åº•éƒ¨é—´è· -->
    <view style="height: 200rpx;"></view>
  </scroll-view>

  <!-- æ­¥éª¤1ï¼šç¡®è®¤æäº¤ -->
  <view
    wx:if="{{!readyToSwipe}}"
    class="swipe-submit-area"
    bindtap="confirmReady"
  >
    <view class="swipe-indicator">
      <text class="swipe-icon">â†‘</text>
      <text class="swipe-text">ç¡®å®šæäº¤?</text>
    </view>
  </view>

  <!-- æ­¥éª¤2ï¼šä¸Šæ»‘æäº¤ -->
  <view
    wx:if="{{readyToSwipe}}"
    class="swipe-submit-area {{swipeProgress > 0 ? 'active' : ''}}"
    bindtouchstart="handleTouchStart"
    bindtouchmove="handleTouchMove"
    bindtouchend="handleTouchEnd"
  >
    <view class="swipe-indicator" style="transform: translateY({{-swipeProgress * 0.3}}rpx)">
      <text class="swipe-icon">â†‘</text>
      <text class="swipe-text">{{swipeProgress >= 100 ? 'æ¾æ‰‹æäº¤' : 'å‘ä¸Šæ»‘åŠ¨æäº¤'}}</text>
    </view>
    <view class="swipe-progress-bar">
      <view class="swipe-progress-fill" style="width: {{swipeProgress}}%"></view>
    </view>
  </view>
</view>

<!-- æäº¤åŠ¨ç”»é®ç½©å±‚ -->
<view class="submit-animation-overlay {{showSubmitAnimation ? 'show' : ''}}">
  <view class="animation-content {{animationPhase}}">
    <!-- äº”å½©çº¸å±‘ -->
    <view class="confetti-container" wx:if="{{animationPhase === 'success'}}">
      <view wx:for="{{confettiPieces}}" wx:key="index"
            class="confetti"
            style="left: {{item.left}}%; animation-delay: {{item.delay}}s; background-color: {{item.color}}; animation-duration: {{item.duration}}s;">
      </view>
    </view>

    <!-- æˆåŠŸå›¾æ ‡å’Œæ–‡å­— -->
    <view class="success-content" wx:if="{{animationPhase === 'success'}}">
      <view class="success-icon">âœ“</view>
      <text class="success-text">è¯„ä»·å·²æäº¤</text>
    </view>
  </view>
</view>
