<!--pages/dj-detail/dj-detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <text>{{texts.loading}}</text>
  </view>

  <!-- DJè¯¦æƒ… -->
  <view wx:else class="dj-detail">
    <!-- DJå¤´éƒ¨ä¿¡æ¯ -->
    <view class="dj-header">
      <view class="dj-photo skeleton">
        <image
          src="{{dj.photo_url || '/images/default-avatar.png'}}"
          mode="aspectFill"
          class="photo"
          lazy-load="{{true}}"
        />
      </view>

      <view class="dj-info">
        <view class="dj-name">{{dj.name}}</view>
        <view class="dj-meta">
          <view class="city">{{dj.city}}</view>
          <view wx:if="{{dj.label}}" class="label">{{dj.label}}</view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’®ç»„ -->
      <view class="action-btns">
        <view class="favorite-btn" bindtap="toggleFavorite">
          <text class="icon">{{isFavorited ? 'â˜…' : 'â˜†'}}</text>
        </view>
      </view>
    </view>

    <!-- éŸ³ä¹é£æ ¼æ ‡ç­¾ -->
    <view class="style-tags-section">
      <view class="style-tags">
        <text wx:for="{{dj.styleList}}" wx:key="index" class="tag">{{item}}</text>
      </view>
      <!-- ç®¡ç†å‘˜ç¼–è¾‘æŒ‰é’® -->
      <view wx:if="{{isAdmin}}" class="edit-btn" bindtap="goToEdit">
        <text class="edit-icon">âœ</text>
        <text class="edit-text">ç¼–è¾‘</text>
      </view>
    </view>

    <!-- è¯„åˆ†ç»Ÿè®¡ -->
    <view class="rating-section">
      <view class="overall-rating">
        <view class="rating-value">{{dj.overall_rating}}</view>
        <view class="stars">
          <text wx:for="{{dj.overallStars.full}}" wx:key="index" class="star full">â˜…</text>
          <text wx:for="{{dj.overallStars.empty}}" wx:key="index" class="star empty">â˜†</text>
        </view>
        <view class="review-count">{{dj.review_count}} {{texts.reviews}}</view>
      </view>

      <view class="rating-details">
        <view class="rating-item">
          <text class="label">{{texts.set}}</text>
          <view class="stars-small">
            <text wx:for="{{dj.setStars.full}}" wx:key="index" class="star">â˜…</text>
            <text wx:for="{{dj.setStars.empty}}" wx:key="index" class="star">â˜†</text>
          </view>
          <text class="value">{{dj.set_rating}}</text>
        </view>

        <view class="rating-item">
          <text class="label">{{texts.performance}}</text>
          <view class="stars-small">
            <text wx:for="{{dj.performanceStars.full}}" wx:key="index" class="star">â˜…</text>
            <text wx:for="{{dj.performanceStars.empty}}" wx:key="index" class="star">â˜†</text>
          </view>
          <text class="value">{{dj.performance_rating}}</text>
        </view>

        <view class="rating-item">
          <text class="label">{{texts.personality}}</text>
          <view class="stars-small">
            <text wx:for="{{dj.personalityStars.full}}" wx:key="index" class="star">â˜…</text>
            <text wx:for="{{dj.personalityStars.empty}}" wx:key="index" class="star">â˜†</text>
          </view>
          <text class="value">{{dj.personality_rating}}</text>
        </view>

        <view class="rating-item would-choose">
          <text class="label">{{texts.wouldChooseAgain}}</text>
          <view class="stars-small"></view>
          <text class="value highlight">{{dj.would_choose_again_percent}}%</text>
        </view>
      </view>
    </view>

    <!-- è¯„è®ºåŒºåŸŸ -->
    <view class="reviews-section">
      <view class="section-header">
        <text class="title">{{texts.reviews}} ({{dj.review_count}})</text>
        <text class="sort-btn" bindtap="showSortOptions">
          {{sortOptions[selectedSortIndex]}} â–¼
        </text>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view wx:if="{{reviews.length > 0}}" class="review-list">
        <view wx:for="{{reviews}}" wx:key="id" class="review-card">
          <view class="review-header">
            <view class="avatar-wrapper skeleton">
              <image
                src="{{item.is_anonymous ? '/images/anonymous-avatar.png' : item.avatar_url}}"
                class="avatar"
                lazy-load="{{true}}"
              />
            </view>
            <view class="user-info">
              <text class="nickname">{{item.is_anonymous ? texts.anonymousUser : item.nickname}}</text>
              <text class="date">{{item.formattedDate}}</text>
            </view>
            <view class="rating">
              <text wx:for="{{item.stars.full}}" wx:key="index" class="star">â˜…</text>
              <text wx:for="{{item.stars.empty}}" wx:key="index" class="star empty">â˜†</text>
            </view>
          </view>

          <view class="review-content">
            <!-- è¯„åˆ†è¯¦æƒ… -->
            <view class="rating-row">
              <text class="item">{{texts.set}}: {{item.set_rating}}</text>
              <text class="item">{{texts.performance}}: {{item.performance_rating}}</text>
              <text class="item">{{texts.personality}}: {{item.personality_rating}}</text>
              <text wx:if="{{item.would_choose_again !== null}}" class="item {{item.would_choose_again ? 'would-choose-yes' : 'would-choose-no'}}">
                {{item.would_choose_again ? 'âœ“' : 'âœ—'}} {{texts.wouldChooseAgain}}
              </text>
            </view>

            <!-- æ ‡ç­¾ -->
            <view wx:if="{{item.tagList.length > 0}}" class="tags">
              <text wx:for="{{item.tagList}}" wx:key="index" class="tag">{{item}}</text>
            </view>

            <!-- è¯„è®ºæ–‡å­— -->
            <text wx:if="{{item.comment}}" class="comment">{{item.comment}}</text>
          </view>

          <view class="review-actions">
            <view class="action" bindtap="markHelpful" data-id="{{item.id}}">
              <text class="icon">ğŸ‘</text>
              <text class="count">{{item.helpful_count}}</text>
            </view>
            <view class="action" bindtap="markNotHelpful" data-id="{{item.id}}">
              <text class="icon">ğŸ‘</text>
              <text class="count">{{item.not_helpful_count}}</text>
            </view>
            <view class="action report" bindtap="reportReview" data-id="{{item.id}}">
              <text class="icon">!</text>
              <text>{{texts.report}}</text>
            </view>
          </view>

          <!-- è¯„è®ºåŒº -->
          <view class="comments-section">
            <view class="comments-header" bindtap="toggleComments" data-review-id="{{item.id}}">
              <text class="comment-count">ğŸ’¬ {{item.comment_count || 0}} æ¡è¯„è®º</text>
              <text class="toggle-icon">{{expandedComments[item.id] ? 'â–¼' : 'â–¶'}}</text>
            </view>

            <view wx:if="{{expandedComments[item.id]}}" class="comments-content">
              <!-- å†™è¯„è®ºè¾“å…¥æ¡† -->
              <view class="write-comment">
                <input class="comment-input"
                       placeholder="{{replyingTo ? 'å›å¤ @' + replyingToNickname + '...' : 'å†™è¯„è®º...'}}"
                       bindinput="onCommentInput"
                       bindconfirm="submitComment"
                       data-review-id="{{item.id}}"
                       value="{{commentInputs[item.id]}}"
                       maxlength="500" />
                <button class="submit-comment-btn" bindtap="submitComment" data-review-id="{{item.id}}">å‘é€</button>
              </view>

              <!-- è¯„è®ºåˆ—è¡¨ -->
              <comment-list
                wx:if="{{reviewComments[item.id] && reviewComments[item.id].length > 0}}"
                comments="{{reviewComments[item.id]}}"
                bind:upvote="handleCommentUpvote"
                bind:downvote="handleCommentDownvote"
                bind:reply="handleCommentReply"
                bind:delete="handleCommentDelete" />

              <view wx:if="{{!reviewComments[item.id] || reviewComments[item.id].length === 0}}" class="no-comments">
                æš‚æ— è¯„è®ºï¼Œæ¥è¯´ç‚¹ä»€ä¹ˆå§
              </view>
            </view>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤š -->
        <view class="load-more">
          <text wx:if="{{hasMore && !reviewsLoading}}" class="btn" bindtap="loadMoreReviews">
            {{texts.loadMore}}
          </text>
          <text wx:elif="{{reviewsLoading}}" class="loading-text">{{texts.loading}}</text>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:else class="empty-state">
        <text>{{texts.noReviews}}</text>
      </view>
    </view>

    <!-- åº•éƒ¨å†™è¯„è®ºæŒ‰é’® -->
    <view class="write-review-btn" bindtap="goToWriteReview">
      <text>{{texts.writeReview}}</text>
    </view>
  </view>
</view>
