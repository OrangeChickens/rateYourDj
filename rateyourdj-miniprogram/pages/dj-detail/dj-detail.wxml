<!--pages/dj-detail/dj-detail.wxml-->
<view class="container">
  <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
  <view wx:if="{{loading}}" class="loading">
    <text>{{texts.loading}}</text>
  </view>

  <!-- DJËØ¶ÊÉÖ -->
  <view wx:else class="dj-detail">
    <!-- DJÂ§¥ÈÉ®‰ø°ÊÅØ -->
    <view class="dj-header">
      <view class="dj-photo skeleton">
        <image
          src="{{dj.photo_url || '/images/default-avatar.png'}}"
          mode="aspectFill"
          class="photo"
          lazy-load="{{true}}"
        />
      </view>

      <view class="dj-info">
        <view class="dj-name">{{dj.name}}</view>
        <view class="dj-meta">
          <view class="city">{{dj.city}}</view>
          <view wx:if="{{dj.label}}" class="label">{{dj.label}}</view>
        </view>
      </view>

      <!-- Êìç‰ΩúÊåâÈíÆÁªÑ -->
      <view class="action-btns">
        <view class="favorite-btn" bindtap="toggleFavorite">
          <text class="icon">{{isFavorited ? '‚òÖ' : '‚òÜ'}}</text>
        </view>
      </view>
    </view>

    <!-- Èü≥‰πêÈ£éÊ†ºÊ†áÁ≠æ -->
    <view class="style-tags-section">
      <view class="style-tags">
        <text wx:for="{{dj.styleList}}" wx:key="index" class="tag">{{item}}</text>
      </view>
      <!-- ÁÆ°ÁêÜÂëòÁºñËæëÊåâÈíÆ -->
      <view wx:if="{{isAdmin}}" class="edit-btn" bindtap="goToEdit">
        <text class="edit-icon">‚úé</text>
        <text class="edit-text">ÁºñËæë</text>
      </view>
    </view>

    <!-- ËØÑÂàÜÁªüËÆ° -->
    <view class="rating-section">
      <view class="overall-rating">
        <view class="rating-value">{{dj.overall_rating}}</view>
        <view class="stars">
          <text wx:for="{{dj.overallStars.full}}" wx:key="index" class="star full">‚òÖ</text>
          <text wx:for="{{dj.overallStars.empty}}" wx:key="index" class="star empty">‚òÜ</text>
        </view>
        <view class="review-count">{{dj.review_count}} {{texts.reviews}}</view>
      </view>

      <view class="rating-details">
        <view class="rating-item">
          <text class="label">{{texts.set}}</text>
          <view class="stars-small">
            <text wx:for="{{dj.setStars.full}}" wx:key="index" class="star">‚òÖ</text>
            <text wx:for="{{dj.setStars.empty}}" wx:key="index" class="star">‚òÜ</text>
          </view>
          <text class="value">{{dj.set_rating}}</text>
        </view>

        <view class="rating-item">
          <text class="label">{{texts.performance}}</text>
          <view class="stars-small">
            <text wx:for="{{dj.performanceStars.full}}" wx:key="index" class="star">‚òÖ</text>
            <text wx:for="{{dj.performanceStars.empty}}" wx:key="index" class="star">‚òÜ</text>
          </view>
          <text class="value">{{dj.performance_rating}}</text>
        </view>

        <view class="rating-item">
          <text class="label">{{texts.personality}}</text>
          <view class="stars-small">
            <text wx:for="{{dj.personalityStars.full}}" wx:key="index" class="star">‚òÖ</text>
            <text wx:for="{{dj.personalityStars.empty}}" wx:key="index" class="star">‚òÜ</text>
          </view>
          <text class="value">{{dj.personality_rating}}</text>
        </view>

        <view class="rating-item would-choose">
          <text class="label">{{texts.wouldChooseAgain}}</text>
          <view class="stars-small"></view>
          <text class="value highlight">{{dj.would_choose_again_percent}}%</text>
        </view>
      </view>
    </view>

    <!-- ËØÑËÆ∫Âå∫Âüü -->
    <view class="reviews-section">
      <view class="section-header">
        <text class="title">{{texts.reviews}} ({{dj.review_count}})</text>
        <text class="sort-btn" bindtap="showSortOptions">
          {{sortOptions[selectedSortIndex]}} ‚ñº
        </text>
      </view>

      <!-- ËØÑËÆ∫ÂàóË°® -->
      <view wx:if="{{reviews.length > 0}}" class="review-list">
        <view wx:for="{{reviews}}" wx:key="id" class="review-card">
          <view class="review-header">
            <view class="avatar-wrapper skeleton">
              <image
                src="{{item.is_anonymous ? '/images/anonymous-avatar.png' : item.avatar_url}}"
                class="avatar"
                lazy-load="{{true}}"
              />
            </view>
            <view class="user-info">
              <text class="nickname">{{item.is_anonymous ? texts.anonymousUser : item.nickname}}</text>
              <text class="date">{{item.formattedDate}}</text>
            </view>
            <view class="rating">
              <text wx:for="{{item.stars.full}}" wx:key="index" class="star">‚òÖ</text>
              <text wx:for="{{item.stars.empty}}" wx:key="index" class="star empty">‚òÜ</text>
            </view>
          </view>

          <view class="review-content">
            <!-- ËØÑÂàÜËØ¶ÊÉÖ -->
            <view class="rating-row">
              <text class="item">{{texts.set}}: {{item.set_rating}}</text>
              <text class="item">{{texts.performance}}: {{item.performance_rating}}</text>
              <text class="item">{{texts.personality}}: {{item.personality_rating}}</text>
              <text wx:if="{{item.would_choose_again !== null}}" class="item {{item.would_choose_again ? 'would-choose-yes' : 'would-choose-no'}}">
                {{item.would_choose_again ? '‚úì' : '‚úó'}} {{texts.wouldChooseAgain}}
              </text>
            </view>

            <!-- Ê†áÁ≠æ -->
            <view wx:if="{{item.tagList.length > 0}}" class="tags">
              <text wx:for="{{item.tagList}}" wx:key="index" class="tag">{{item}}</text>
            </view>

            <!-- ËØÑËÆ∫ÊñáÂ≠ó -->
            <text wx:if="{{item.comment}}" class="comment">{{item.comment}}</text>
          </view>

          <!-- ‰∫íÂä®Âå∫Âüü - Reddit È£éÊ†º -->
          <view class="review-interactions">
            <!-- Á¨¨‰∏ÄË°åÔºöVote, Reply, Report, Share -->
            <view class="review-actions">
              <view class="action vote">
                <text class="icon up" bindtap="markHelpful" data-id="{{item.id}}">‚ñ≤</text>
                <text class="count">{{item.helpful_count - item.not_helpful_count}}</text>
                <text class="icon down" bindtap="markNotHelpful" data-id="{{item.id}}">‚ñº</text>
              </view>

              <view class="action" bindtap="toggleComments" data-review-id="{{item.id}}">
                <text class="icon">üí¨</text>
                <text>{{texts.reply}}</text>
              </view>

              <view class="action" bindtap="reportReview" data-id="{{item.id}}">
                <text class="icon">!</text>
                <text>{{texts.report}}</text>
              </view>

              <button class="action share-btn" open-type="share" data-dj-id="{{dj.id}}" data-review-id="{{item.id}}">
                <text class="icon">‚Üó</text>
                <text>{{texts.share}}</text>
              </button>
            </view>

            <!-- Á¨¨‰∫åË°åÔºöÂ±ïÂºÄËØÑËÆ∫Êï∞ -->
            <view class="comments-expand" bindtap="toggleComments" data-review-id="{{item.id}}">
              <text class="expand-icon">{{expandedComments[item.id] ? '‚äñ' : '‚äï'}}</text>
              <text class="expand-text">{{item.comment_count || 0}} Êù°ËØÑËÆ∫</text>
            </view>
          </view>

          <!-- ËØÑËÆ∫Âå∫ -->
          <view class="comments-section">
            <view wx:if="{{expandedComments[item.id]}}" class="comments-content-wrapper">
              <!-- ÂÜôÈ°∂Á∫ßËØÑËÆ∫ËæìÂÖ•Ê°Ü -->
              <view class="write-comment">
                <input class="comment-input"
                       placeholder="ÂÜôËØÑËÆ∫..."
                       bindinput="onCommentInput"
                       bindconfirm="submitComment"
                       data-review-id="{{item.id}}"
                       value="{{commentInputs[item.id]}}"
                       maxlength="500" />
                <button class="submit-comment-btn" bindtap="submitComment" data-review-id="{{item.id}}">ÂèëÈÄÅ</button>
              </view>

              <!-- ËØÑËÆ∫ÂàóË°® -->
              <comment-list
                wx:if="{{reviewComments[item.id] && reviewComments[item.id].length > 0}}"
                comments="{{reviewComments[item.id]}}"
                reviewId="{{item.id}}"
                replyingCommentId="{{replyingTo[item.id]}}"
                replyingNickname="{{replyingToNickname[item.id]}}"
                replyInputValue="{{replyInputValue[item.id]}}"
                bind:upvote="handleCommentUpvote"
                bind:downvote="handleCommentDownvote"
                bind:reply="handleCommentReply"
                bind:toggleReply="handleToggleReply"
                bind:replyInput="handleReplyInput"
                bind:submitReply="handleSubmitReply"
                bind:cancelReply="handleCancelReply"
                bind:delete="handleCommentDelete" />

              <view wx:if="{{!reviewComments[item.id] || reviewComments[item.id].length === 0}}" class="no-comments">
                ÊöÇÊó†ËØÑËÆ∫ÔºåÊù•ËØ¥ÁÇπ‰ªÄ‰πàÂêß
              </view>
            </view>
          </view>
        </view>

        <!-- Âä†ËΩΩÊõ¥Â§ö -->
        <view class="load-more">
          <text wx:if="{{hasMore && !reviewsLoading}}" class="btn" bindtap="loadMoreReviews">
            {{texts.loadMore}}
          </text>
          <text wx:elif="{{reviewsLoading}}" class="loading-text">{{texts.loading}}</text>
        </view>
      </view>

      <!-- Á©∫Áä∂ÊÄÅ -->
      <view wx:else class="empty-state">
        <text>{{texts.noReviews}}</text>
      </view>
    </view>

    <!-- Â∫ïÈÉ®ÂÜôËØÑËÆ∫ÊåâÈíÆ -->
    <view class="write-review-btn" bindtap="goToWriteReview">
      <text>{{texts.writeReview}}</text>
    </view>
  </view>
</view>
